
<!DOCTYPE html>

<html>
<head>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
</head>
<title>Kutpe KZ</title>
<style>
*{
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;

}

    .box{
        height: 150%;
        width: 150%;
        justify-content: center;
        background-color: #d5cdfc;
        align-self: center;
        -webkit-border-radius:10px;
        padding: 20px;

       

    }
    .bbox{
        padding-top: 5%;
        padding-left: 5%;
        height: 60%;
        width: 60%;
    }

    .delete_btn{
      border: none;
      outline: none;
    }

    .update_btn{
      border: none;
      outline: none;
    }

    .dropbtn {
  background-color: #6246EA;
  color: white;
  padding: 16px;
  font-size: 16px;
  -webkit-border-radius:10px;
  border: none;
  cursor: pointer;
  }

.dropdown {
  position: relative;
  display: inline-block;
  padding-bottom: 20px;
}

.dropdown-content {
  display: none;
  position: absolute;
  background-color: #f9f9f9;
  min-width: 160px;
  box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
  z-index: 1;
}

.dropdown-content a {
  color: black;
  padding: 12px 16px;
  text-decoration: none;
  display: block;
}

.dropdown-content a:hover {background-color: #f1f1f1}

.dropdown:hover .dropdown-content {
  display: block;
}

.dropdown:hover .dropbtn {
  background-color: #7a63eb;
}
.btn-group .button {
  background-color: #6246EA; /* Green */
  border: 1px solid #7a63eb;
  color: white;
  padding: 15px 32px;
  text-align: center;
  text-decoration: none;
  display: inline-block;
  font-size: 16px;
  cursor: pointer;
  float: right;
  
}
.btn-group{
    width: 163%;
    padding-top: 20px;
}

.btn-group .button:not(:last-child) {
  border-right: none; /* Prevent double borders */
}

.btn-group .button:hover {
  background-color: #7a63eb;
}

ul {
  list-style-type: none;
  margin: 0;
  padding: 0;
  overflow: hidden;
  background-color: #6246EA;
  height: 100%;
}

li {
  float: right;
  height: 70px;
}

li a {
  display: block;
  color: white;
  text-align: center;
  padding: 14px 16px;
  margin-top: 10px;
  text-decoration: none;
}

li a:hover:not(.active) {
  background-color: #7a63eb;
}


</style>
<script type="module" id="script" class="main">

  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.18.0/firebase-app.js";
  import { getFirestore, doc, getDoc, getDocs, collection, deleteDoc} from "https://www.gstatic.com/firebasejs/9.18.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAtp86S0T2BNVUUdgjeDltaZEP1u2MsvHc",
    authDomain: "kutpe-kz.firebaseapp.com",
    databaseURL: "https://kutpe-kz-default-rtdb.firebaseio.com",
    projectId: "kutpe-kz",
    storageBucket: "kutpe-kz.appspot.com",
    messagingSenderId: "760528812857",
    appId: "1:760528812857:web:2fa9b7ccdea76b6c9946e8",
    measurementId: "G-1SR0FR7BFS"
  };

  const app = initializeApp(firebaseConfig);
  const firestore = getFirestore();
  const usersCol = collection(firestore, 'users');
  const carWashesCol = collection(firestore, 'car-washes');

  getUser()
  //getCarWashes()

  var userBtn = document.getElementById("showUsers");
  var carWashesBtn = document.getElementById("showCarWashes");

  userBtn.addEventListener('click', getUser)
  carWashesBtn.addEventListener('click', getCarWashes);

  async function getUser(){
    await (document.getElementById('cols').replaceChildren());
    await document.getElementById('user').replaceChildren();
    getDocs(usersCol).then((snapshot) => {
      let users = []
      let car_washes = []
      var col = document.getElementById('cols');
      var thId = document.createElement('th');
      var thName = document.createElement('th');
      var thPhone = document.createElement('th');
      var thCreatedAt = document.createElement('th');
      var thBookingTimes = document.createElement('th');
      thId.innerHTML = "#"; thName.innerHTML = "Имя"; thPhone.innerHTML = "Телефон"; thCreatedAt.innerHTML = "Аккаунт создан"; thBookingTimes.innerHTML = "Количество броней";
      col.appendChild(thId); col.appendChild(thName); col.appendChild(thPhone); col.appendChild(thCreatedAt); col.appendChild(thBookingTimes);

      snapshot.docs.forEach((doc) => {
        var phone = doc.data().phoneNumber;
        users.push({...doc.data(), id: doc.id});
        var userTbody = document.getElementById("user");
        var tRow = document.createElement("tr");
        var tdId = document.createElement("td");
        var tdName = document.createElement("td");
        var tdPhone = document.createElement("td");
        var tdCreatedAt = document.createElement("td");
        var tdBookingTimes = document.createElement("td");
  
        tdId.innerHTML = users.length;
        tdName.innerHTML = doc.data().name;
        tdPhone.innerHTML = doc.data().phoneNumber;

        let map = new Map(Object.entries(doc.data().history));

        tdBookingTimes.innerHTML = map.get("addresses").length;

        let seconds = parseInt(doc.data().createdAt);
        let date = new Date(seconds).toLocaleString('ru-RU', { timeZone: 'UTC' })

        tdCreatedAt.innerHTML = date;


        tRow.appendChild(tdId); tRow.appendChild(tdName); tRow.appendChild(tdPhone); tRow.appendChild(tdCreatedAt);  tRow.appendChild(tdBookingTimes);
        userTbody.appendChild(tRow);
      }) 
    }).catch(err => {
      console.log(err.message)
    })
  }

    async function getCarWashes(){
      await (document.getElementById('cols').replaceChildren());
      await document.getElementById('user').replaceChildren();
      getDocs(carWashesCol).then((snapshot) => {
        let car_washes = []

        var col = document.getElementById('cols');
        var thId = document.createElement('th');
        var thName = document.createElement('th');
        var thAddress = document.createElement('th');
        var thPhone = document.createElement('th');
        var thWeekDay = document.createElement('th');
        var thWeekEnd = document.createElement('th');
        var thLat = document.createElement('th');
        var thLong = document.createElement('th');
        thId.innerHTML = "#"; thName.innerHTML = "Название"; thAddress.innerHTML = "Адресс"; thPhone.innerHTML = "Телефон"; thWeekDay.innerHTML = "Будни"; thWeekEnd.innerHTML = "Выходные"; thLat.innerHTML = "Широта"; thLong.innerHTML = "Долгота";
        col.appendChild(thId); col.appendChild(thName); col.appendChild(thAddress); col.appendChild(thPhone); col.appendChild(thWeekDay); col.appendChild(thWeekEnd); col.appendChild(thLat); col.appendChild(thLong); 

        snapshot.docs.forEach((doc) => {
        car_washes.push({...doc.data(), id: doc.id})
        //var dropDown = document.getElementById('drop-down')
        var carWashTbody = document.getElementById("user");
        var tRow = document.createElement("tr");
        var tdId = document.createElement("td");
        var tdName = document.createElement("td");
        var tdAddress = document.createElement("td");
        var tdPhone = document.createElement("td");
        var tdWeekday = document.createElement("td");
        var tdWeekend = document.createElement("td");
        var tdLat = document.createElement("td");
        var tdLong = document.createElement("td");

        var tdDeleteButton = document.createElement("button");
        tdDeleteButton.className = "delete_btn";
        tdDeleteButton.onclick = function(){removeData(doc.id, false, tdName.innerHTML, doc.data().uid)};
        tdDeleteButton.innerHTML = '<i class="fa fa-trash"></i>';

        var tdUpdateButton = document.createElement("button");
        tdUpdateButton.className = "update_btn";
        tdUpdateButton.onclick = function(){updateData(doc.id, false, doc.data())};
        tdUpdateButton.innerHTML = '<i class="fa fa-edit"></i>';


        tdId.innerHTML = car_washes.length;
        tdName.innerHTML = doc.data().name;
        tdAddress.innerHTML = doc.data().address;
        tdPhone.innerHTML = doc.data().phoneNumber;
        tdWeekday.innerHTML = doc.data().weekDayHours;
        tdWeekend.innerHTML = doc.data().weekEndHours;
        tdLat.innerHTML = doc.data().latitude;
        tdLong.innerHTML = doc.data().longitude;
        tRow.appendChild(tdId); tRow.appendChild(tdName); tRow.appendChild(tdAddress); tRow.appendChild(tdPhone); tRow.appendChild(tdWeekday); tRow.appendChild(tdWeekend); tRow.appendChild(tdLat); tRow.appendChild(tdLong); 
        
        tRow.appendChild(tdUpdateButton); tRow.appendChild(tdDeleteButton);
        carWashTbody.appendChild(tRow);
        }) 
      }).catch(err => {
        console.log(err.message)
      })
    }

    function removeData(id, isUser, name, uid){
      if(confirm("Вы действительно хотите удалить " + (isUser ? "Пользователя" : "Автомойку") + ": " + name)){
        console.log("Ok")
        deleteDoc(doc(firestore, (isUser ? "users" : "car-washes"), uid)).then(()=>alert("Успешно удалено")).catch((error) => alert("Ошибка: " + error));
      }
      else console.log("Cancel");
    }

    function updateData(id, isUser, data){
      var div = document.getElementById("updateDiv");
      div.replaceChildren();
      var form = document.createElement("form");
      if(isUser){
        form.innerHTML += "<label for=\"name\">Имя:</label><br>";
        form.innerHTML += "<input type=\"text\" id=\"name\" name=\"name\"><br>";
        form.innerHTML += "<label for=\"phone\">Телефон:</label><br>";
        form.innerHTML += "<input type=\"text\" id=\"phone\" name=\"phone\"><br>";
        form.innerHTML += "<label for=\"created\">Аккаунт создан:</label><br>";
        form.innerHTML += "<input type=\"text\" id=\"created\" name=\"created\"><br>";
        form.innerHTML += "<label for=\"bookings\">Количество броней:</label><br>";
        form.innerHTML += "<input type=\"text\" id=\"bookings\" name=\"bookings\"><br>";
      }
      else{
        form.innerHTML += "<label for=\"name\">Имя:</label><br>";
        form.innerHTML += "<input type=\"text\" id=\"name\" name=\"name\"><br>";
        form.innerHTML += "<label for=\"address\">Адресс:</label><br>";
        form.innerHTML += "<input type=\"text\" id=\"address\" name=\"address\"><br>";
        form.innerHTML += "<label for=\"phone\">Телефон:</label><br>";
        form.innerHTML += "<input type=\"text\" id=\"phone\" name=\"phone\"><br>";
        form.innerHTML += "<label for=\"weekday\">Будни:</label><br>";
        form.innerHTML += "<input type=\"text\" id=\"weekday\" name=\"weekday\"><br>";
        form.innerHTML += "<label for=\"weekend\">Выходные:</label><br>";
        form.innerHTML += "<input type=\"text\" id=\"weekend\" name=\"weekend\"><br>";
        form.innerHTML += "<label for=\"lat\">Широта:</label><br>";
        form.innerHTML += "<input type=\"text\" id=\"lat\" name=\"lat\"><br>";
        form.innerHTML += "<label for=\"long\">Долгота:</label><br>";
        form.innerHTML += "<input type=\"text\" id=\"long\" name=\"long\"><br>";
      }
      form.innerHTML += "<input type=\"submit\" value=\"Сохранить\">";
      div.appendChild(form);
    }
    </script>
<body>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

  <header>
    <ul>
      <li style="float:left"><a href="#home">Kutpe KZ</a></li>
      <li><a href="data_edit.html">User</a></li>
      <li><a href="#contact">Logout</a></li>
     
    </ul>
    
  </header>


<section class="bbox">
  <div class="btn-group">
    <button class="button" id="showUsers" >Пользователи</button>
    <button class="button" id="showCarWashes">Автомойки</button>
  </div>
  <div class="box">
    <table class="table table-stripped">
      <thead>
        <tr id="cols"></tr>
      </thead>
      <tbody id="user"></tbody>
    </table>
  </div>
  <div id="updateDiv"></div>
  <div id="addDiv"></div>

    </section>

</body>
</html>